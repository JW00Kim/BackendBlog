// ============================================================
// ğŸ“¦ ëª¨ë“ˆ Import
// ============================================================
const express = require("express"); // Express ë¼ìš°í„°
const router = express.Router(); // ë¼ìš°í„° ì¸ìŠ¤í„´ìŠ¤ ìƒì„±
const jwt = require("jsonwebtoken"); // JWT í† í° ìƒì„±/ê²€ì¦ ë¼ì´ë¸ŒëŸ¬ë¦¬
const { OAuth2Client } = require("google-auth-library"); // Google OAuth 2.0 í´ë¼ì´ì–¸íŠ¸
const User = require("../models/User"); // MongoDB ì‚¬ìš©ì ëª¨ë¸

// ============================================================
// ğŸ”§ Google OAuth í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™”
// ============================================================
// í™˜ê²½ ë³€ìˆ˜ì—ì„œ Google Client IDë¥¼ ê°€ì ¸ì™€ OAuth í´ë¼ì´ì–¸íŠ¸ ìƒì„±
// ì´ í´ë¼ì´ì–¸íŠ¸ëŠ” Googleì—ì„œ ë°›ì€ ID í† í°ì„ ê²€ì¦í•˜ëŠ” ë° ì‚¬ìš©ë©ë‹ˆë‹¤.
const googleClient = new OAuth2Client(process.env.GOOGLE_CLIENT_ID);

// ============================================================
// ğŸ”‘ JWT í† í° ìƒì„± í•¨ìˆ˜
// ============================================================
/**
 * ì‚¬ìš©ì IDë¥¼ ê¸°ë°˜ìœ¼ë¡œ JWT ì•¡ì„¸ìŠ¤ í† í°ì„ ìƒì„±í•©ë‹ˆë‹¤.
 * @param {string} userId - MongoDB ì‚¬ìš©ì ObjectId
 * @returns {string} JWT í† í° (30ì¼ ìœ íš¨)
 */
const generateToken = (userId) => {
  return jwt.sign({ id: userId }, process.env.JWT_SECRET, {
    expiresIn: "30d", // í† í° ë§Œë£Œ ê¸°ê°„: 30ì¼
  });
};

// @route   POST /api/auth/signup
// @desc    íšŒì›ê°€ì…
// @access  Public
router.post("/signup", async (req, res) => {
  // ë¡œì§ ì„¤ëª…í•´ì¤„ë˜?
  // ìš”ì²­ ë°”ë””ì—ì„œ ì´ë©”ì¼, ë¹„ë°€ë²ˆí˜¸, ì´ë¦„ ì¶”ì¶œ
  // í•„ìˆ˜ í•„ë“œ ì²´í¬
  // ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì´ë©”ì¼ ì²´í¬
  // ìƒˆ ì‚¬ìš©ì ìƒì„±
  // JWT í† í° ìƒì„±
  // ì‘ë‹µ ë°˜í™˜
  try {
    const { email, password, name } = req.body; // ìš”ì²­ ë°”ë””ì—ì„œ ì´ë©”ì¼, ë¹„ë°€ë²ˆí˜¸, ì´ë¦„ ì¶”ì¶œ

    // í•„ìˆ˜ í•„ë“œ ì²´í¬
    if (!email || !password || !name) {
      return res.status(400).json({
        success: false,
        message: "ëª¨ë“  í•„ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”",
      });
    }

    // ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì´ë©”ì¼ ì²´í¬
    const existingUser = await User.findOne({ email });
    if (existingUser) {
      return res.status(400).json({
        success: false,
        message: "ì´ë¯¸ ì‚¬ìš©ì¤‘ì¸ ì´ë©”ì¼ì…ë‹ˆë‹¤",
      });
    }

    // ìƒˆ ì‚¬ìš©ì ìƒì„±
    const user = await User.create({
      email,
      password,
      name,
    });

    // JWT í† í° ìƒì„±
    const token = generateToken(user._id);

    // ì‘ë‹µ ë°˜í™˜
    res.status(201).json({
      success: true,
      message: "íšŒì›ê°€ì…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤",
      data: {
        user: {
          id: user._id,
          email: user.email,
          name: user.name,
          createdAt: user.createdAt,
        },
        token,
      },
    });
  } catch (error) {
    console.error("íšŒì›ê°€ì… ì—ëŸ¬:", error);
    res.status(500).json({
      success: false,
      message: "ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤",
      error: error.message,
    });
  }
});

// @route   POST /api/auth/login
// @desc    ë¡œê·¸ì¸
// @access  Public
router.post("/login", async (req, res) => {
  try {
    const { email, password } = req.body; // í´ë¼ì´ì–¸íŠ¸ ì—ì„œ ë³´ë‚¸ ë°ì´í„°

    // í•„ìˆ˜ í•„ë“œ ì²´í¬
    if (!email || !password) {
      return res.status(400).json({
        success: false,
        message: "ì´ë©”ì¼ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”",
      });
    }

    // ì‚¬ìš©ì ì°¾ê¸° (ë¹„ë°€ë²ˆí˜¸ í¬í•¨)
    const user = await User.findOne({ email }).select("+password");
    if (!user) {
      return res.status(401).json({
        success: false,
        message: "ì´ë©”ì¼ ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ì˜ëª»ë˜ì—ˆìŠµë‹ˆë‹¤",
      });
    }

    // ë¹„ë°€ë²ˆí˜¸ í™•ì¸
    const isPasswordMatch = await user.matchPassword(password);
    if (!isPasswordMatch) {
      return res.status(401).json({
        success: false,
        message: "ì´ë©”ì¼ ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ì˜ëª»ë˜ì—ˆìŠµë‹ˆë‹¤",
      });
    }

    // ========== í—ˆìš©ëœ ì‚¬ìš©ì ì´ë¦„ í™•ì¸ ==========
    // const allowedNames = ["ê¹€ì§€ì›", "ì •ìœ¤ì„œ", "ê¹€ìŠ¹ì£¼"]; // í—ˆìš©í•  ì´ë¦„ ëª©ë¡

    // if (!allowedNames.includes(user.name)) {
    //   return res.status(403).json({
    //     success: false,
    //     message: "ë¡œê·¸ì¸ ê¶Œí•œì´ ì—†ëŠ” ì‚¬ìš©ìì…ë‹ˆë‹¤",
    //   });
    // }

    // JWT í† í° ìƒì„±
    const token = generateToken(user._id);

    res.json({
      success: true,
      message: "ë¡œê·¸ì¸ ì„±ê³µ",
      data: {
        user: {
          id: user._id,
          email: user.email,
          name: user.name,
          createdAt: user.createdAt,
        },
        token,
      },
    });
  } catch (error) {
    console.error("ë¡œê·¸ì¸ ì—ëŸ¬:", error);
    res.status(500).json({
      success: false,
      message: "ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤",
      error: error.message,
    });
  }
});

// @route   GET /api/auth/me
// @desc    í˜„ì¬ ë¡œê·¸ì¸í•œ ì‚¬ìš©ì ì •ë³´
// @access  Private (í† í° í•„ìš”)
router.get("/me", async (req, res) => {
  try {
    // Authorization í—¤ë”ì—ì„œ í† í° ì¶”ì¶œ
    const token = req.headers.authorization?.split(" ")[1];

    if (!token) {
      return res.status(401).json({
        success: false,
        message: "ì¸ì¦ í† í°ì´ í•„ìš”í•©ë‹ˆë‹¤",
      });
    }

    // í† í° ê²€ì¦
    const decoded = jwt.verify(token, process.env.JWT_SECRET);
    const user = await User.findById(decoded.id);

    if (!user) {
      return res.status(404).json({
        success: false,
        message: "ì‚¬ìš©ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤",
      });
    }

    res.json({
      success: true,
      data: {
        user: {
          id: user._id,
          email: user.email,
          name: user.name,
          createdAt: user.createdAt,
        },
      },
    });
  } catch (error) {
    console.error("ì¸ì¦ ì—ëŸ¬:", error);
    res.status(401).json({
      success: false,
      message: "ìœ íš¨í•˜ì§€ ì•Šì€ í† í°ì…ë‹ˆë‹¤",
      error: error.message,
    });
  }
});

// ============================================================
// ğŸ” Google OAuth ë¡œê·¸ì¸ ì—”ë“œí¬ì¸íŠ¸
// ============================================================
/**
 * @route   POST /api/auth/google
 * @desc    Google OAuth 2.0ì„ í†µí•œ ë¡œê·¸ì¸/íšŒì›ê°€ì…
 * @access  Public (ì¸ì¦ ë¶ˆí•„ìš”)
 * 
 * ğŸ“ ì²˜ë¦¬ íë¦„:
 * 1. í”„ë¡ íŠ¸ì—”ë“œì—ì„œ Google Sign-Inìœ¼ë¡œ ë°›ì€ credential(ID Token) ìˆ˜ì‹ 
 * 2. Google APIë¡œ í† í° ê²€ì¦ (ìœ„ì¡° ë°©ì§€)
 * 3. ì´ë©”ì¼ë¡œ ê¸°ì¡´ ì‚¬ìš©ì í™•ì¸
 * 4. ì‹ ê·œ ì‚¬ìš©ìë©´ ìë™ íšŒì›ê°€ì…, ê¸°ì¡´ ì‚¬ìš©ìë©´ ì •ë³´ ì—…ë°ì´íŠ¸
 * 5. JWT í† í° ìƒì„± ë° ë°˜í™˜
 */
router.post("/google", async (req, res) => {
  try {
    // 1ï¸âƒ£ í”„ë¡ íŠ¸ì—”ë“œì—ì„œ ì „ì†¡í•œ Google credential(ID Token) ì¶”ì¶œ
    const { credential } = req.body;
    
    console.log("ğŸ” Google ë¡œê·¸ì¸ ìš”ì²­");

    // credential í•„ìˆ˜ ì²´í¬
    if (!credential) {
      return res.status(400).json({
        success: false,
        message: "Google ì¸ì¦ í† í°ì´ í•„ìš”í•©ë‹ˆë‹¤",
      });
    }

    // 2ï¸âƒ£ Google OAuth í´ë¼ì´ì–¸íŠ¸ë¡œ ID í† í° ê²€ì¦
    // - í† í°ì´ ì‹¤ì œë¡œ Googleì—ì„œ ë°œê¸‰í•œ ê²ƒì¸ì§€ í™•ì¸
    // - í† í°ì´ ìš°ë¦¬ Client IDë¡œ ë°œê¸‰ëœ ê²ƒì¸ì§€ í™•ì¸
    // - í† í°ì´ ë§Œë£Œë˜ì§€ ì•Šì•˜ëŠ”ì§€ í™•ì¸
    const ticket = await googleClient.verifyIdToken({
      idToken: credential, // í”„ë¡ íŠ¸ì—”ë“œì—ì„œ ë°›ì€ ID í† í°
      audience: process.env.GOOGLE_CLIENT_ID, // ìš°ë¦¬ ì•±ì˜ Client ID
    });

    // 3ï¸âƒ£ ê²€ì¦ëœ í† í°ì—ì„œ ì‚¬ìš©ì ì •ë³´ ì¶”ì¶œ
    const payload = ticket.getPayload();
    const { 
      email,        // ì‚¬ìš©ì ì´ë©”ì¼
      name,         // ì‚¬ìš©ì ì´ë¦„
      sub: googleId, // Google ê³ ìœ  ID (sub = subject)
      picture       // í”„ë¡œí•„ ì´ë¯¸ì§€ URL
    } = payload;

    console.log("âœ… Google í† í° ê²€ì¦ ì™„ë£Œ:", email);

    // 4ï¸âƒ£ ì´ë©”ì¼ë¡œ ê¸°ì¡´ ì‚¬ìš©ì í™•ì¸
    let user = await User.findOne({ email });

    if (!user) {
      // ì‹ ê·œ ì‚¬ìš©ì - ìë™ íšŒì›ê°€ì…
      // Google ë¡œê·¸ì¸ ì‚¬ìš©ìëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ í•„ìš” ì—†ì§€ë§Œ,
      // DB ìŠ¤í‚¤ë§ˆìƒ í•„ìˆ˜ì´ë¯€ë¡œ ëœë¤ ë¹„ë°€ë²ˆí˜¸ ìƒì„± (ì‚¬ìš© ì•ˆ í•¨)
      user = await User.create({
        email,
        name,
        password: Math.random().toString(36).slice(-8) + "Aa1!", // ëœë¤ ë¹„ë°€ë²ˆí˜¸
        googleId, // Google ê³ ìœ  ID ì €ì¥
        profilePicture: picture, // í”„ë¡œí•„ ì´ë¯¸ì§€ URL ì €ì¥
      });
      console.log("âœ… ìƒˆ Google ì‚¬ìš©ì ìƒì„±:", email);
    } else {
      // ê¸°ì¡´ ì‚¬ìš©ì - Google IDê°€ ì—†ìœ¼ë©´ ì—…ë°ì´íŠ¸
      // (ì´ë©”ì¼/ë¹„ë°€ë²ˆí˜¸ë¡œ ê°€ì… í›„ Google ë¡œê·¸ì¸ì„ ì²˜ìŒ ì‚¬ìš©í•˜ëŠ” ê²½ìš°)
      if (!user.googleId) {
        user.googleId = googleId;
        user.profilePicture = picture;
        await user.save();
      }
      console.log("âœ… ê¸°ì¡´ ì‚¬ìš©ì Google ë¡œê·¸ì¸:", email);
    }

    // 5ï¸âƒ£ JWT ì•¡ì„¸ìŠ¤ í† í° ìƒì„±
    // ì´ í† í°ìœ¼ë¡œ ì´í›„ API ìš”ì²­ ì‹œ ì‚¬ìš©ì ì¸ì¦
    const token = generateToken(user._id);

    // 6ï¸âƒ£ ì„±ê³µ ì‘ë‹µ ë°˜í™˜
    res.json({
      success: true,
      message: "Google ë¡œê·¸ì¸ ì„±ê³µ",
      data: {
        user: {
          id: user._id,
          email: user.email,
          name: user.name,
          profilePicture: user.profilePicture, // Google í”„ë¡œí•„ ì´ë¯¸ì§€
          createdAt: user.createdAt,
        },
        token, // JWT í† í° (í”„ë¡ íŠ¸ì—”ë“œì—ì„œ localStorageì— ì €ì¥)
      },
    });
  } catch (error) {
    // ì—ëŸ¬ ì²˜ë¦¬ (í† í° ê²€ì¦ ì‹¤íŒ¨, DB ì˜¤ë¥˜ ë“±)
    console.error("âŒ Google ë¡œê·¸ì¸ ì—ëŸ¬:", error);
    res.status(500).json({
      success: false,
      message: "Google ë¡œê·¸ì¸ ì‹¤íŒ¨",
      error: error.message,
    });
  }
});

module.exports = router;
